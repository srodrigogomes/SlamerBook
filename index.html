import React, { useState, useEffect, useRef } from 'react';
import { 
  BookOpen, Heart, Star, Trophy, Plus, Settings, Check, X, 
  MessageSquare, Loader2, ArrowLeft, Home, Layers, 
  Lightbulb, User, Zap, Lock, Award, Upload, LogIn, UserPlus,
  Feather, Sun, Shield, Sword, Flame, Ghost, RefreshCw, HelpCircle, FileText,
  ChevronRight // Adicionado aqui para corrigir o ReferenceError
} from 'lucide-react';

// ====================================================================
// --- CONFIGURAÇÃO E DADOS (Baseado em "O Livro de Slamer") ---
// ====================================================================

const APP_NAME = "SlamerPath";

const INITIAL_USERS = [
  { username: 'admin', password: '123', name: 'Rodrigo Gomes', email: 'autor@slamer.com', isAdmin: true },
  { username: 'peter', password: '123', name: 'Peter Richt', email: 'peter@inaira.com' }
];

const MOCK_BOOKS = [
  { 
    id: 'slamer_book', 
    title: 'O Livro de Slamer', 
    author: 'Rodrigo Gomes', 
    progress: 0, 
    icon: Feather, 
    color: '#EAB308', 
    isStarter: true
  }
];

// Mapeamento das 6 Fases com 6 Jogos Diferentes
const MAP_STRUCTURE = [
  { id: 'm1', title: 'Solcris: O Convite', phases: 1, gameType: 'Quiz', description: "O início da jornada." }, 
  { id: 'm2', title: 'A Orla de Slamer', phases: 1, gameType: 'Memory', description: "Conheça seus aliados." },
  { id: 'm3', title: 'Luminírios & Denísia', phases: 1, gameType: 'DragAndDrop', description: "Encontre os objetos de poder." },
  { id: 'm4', title: 'O Primeiro Encanto', phases: 1, gameType: 'SpellTyper', description: "Lance feitiços contra as plantas!" },
  { id: 'm5', title: 'Krotons e Cruhell', phases: 1, gameType: 'Battle', description: "Batalha final contra as sombras." },
  { id: 'm6', title: 'Epílogo: A Página Rasgada', phases: 1, gameType: 'Unscramble', description: "Restaure a mensagem final." },
];

// --- DADOS DOS JOGOS ---

// 1. Quiz
const QUIZ_DATA = {
    question: "Qual o nome do fenômeno que transportou Peter e Débora para Inária?",
    options: ["Solcris", "Eclipse Lunar", "Tempestade Solar", "Buraco Negro"],
    correctAnswer: "Solcris",
    hint: "Ocorre quando o círculo de transporte é ativado pela luz."
};

// 2. Drag & Drop (Conexões)
const DRAG_DATA = {
    pairs: [
      { id: 1, target: "Átila", description: "Guardião" },
      { id: 2, target: "Slamer", description: "Criador do Livro" },
      { id: 3, target: "Órion", description: "Reino Sombrio" },
      { id: 4, target: "Inária", description: "Terra de Luz" },
    ],
    sources: [
        { id: 1, content: "Guardião" },
        { id: 2, content: "Terra de Luz" },
        { id: 3, content: "Criador do Livro" },
        { id: 4, content: "Reino Sombrio" },
    ]
};

// 3. Memory Game (Aliados)
const MEMORY_CARDS = [
    { id: 1, icon: User, name: "Peter" },
    { id: 2, icon: Sun, name: "Débora" }, // Débora tem o brilho/pó de estrela
    { id: 3, icon: Shield, name: "Soltesner" }, // Guerreiro
    { id: 4, icon: Feather, name: "Ária" }, // Feiticeira (pena/leveza)
    { id: 5, icon: Ghost, name: "Marley" }, // O "Imortal"
    { id: 6, icon: Sword, name: "Slamer" }, // O Mago original
];

// 4. Spell Typer (Feitiços)
const SPELL_DATA = [
    { spell: "Susccipio", meaning: "A primeira palavra do livro." },
    { spell: "Incêndio Illu Aere", meaning: "Fogo azul contra as plantas." },
    { spell: "Naturae Imperium", meaning: "Comando da natureza." }
];

// 5. Battle (Combate Simples)
const BATTLE_DATA = {
    enemyName: "Cruhell",
    enemyMaxHp: 100,
    playerMaxHp: 100
};

// 6. Unscramble (Restaurar Texto)
const PUZZLE_DATA = {
    correctOrder: [
        "Quando fundi o livro",
        "ao meu corpo,",
        "ele se tornou",
        "parte de mim."
    ],
    scrambled: [
        { id: 'p3', text: "ele se tornou" },
        { id: 'p1', text: "Quando fundi o livro" },
        { id: 'p4', text: "parte de mim." },
        { id: 'p2', text: "ao meu corpo," },
    ]
};

// ====================================================================
// --- COMPONENTES UI REUTILIZÁVEIS ---
// ====================================================================

const HeartsDisplay = ({ count }) => (
  <div className="flex items-center space-x-1 px-3 py-1 bg-red-50 border border-red-100 rounded-full">
    <Heart className="w-4 h-4 text-red-500 fill-red-500" />
    <span className="font-bold text-red-700 text-sm">{count}</span>
  </div>
);

const Modal = ({ title, children, onClose, color = "blue" }) => (
  <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-[100] p-4 backdrop-blur-sm animate-in fade-in">
    <div className="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-md transform transition-all scale-100">
      <h3 className={`text-xl font-black text-${color}-600 mb-4 uppercase tracking-wide`}>{title}</h3>
      <div className="text-slate-600 mb-6 font-medium">{children}</div>
      <button onClick={onClose} className={`w-full py-3 bg-${color}-500 text-white font-bold rounded-xl hover:bg-${color}-600 transition shadow-lg shadow-${color}-200`}>
        Continuar
      </button>
    </div>
  </div>
);

// ====================================================================
// --- JOGOS (GAME COMPONENTS) ---
// ====================================================================

// JOGO 1: QUIZ (Já existente)
const QuizGame = ({ onComplete, onMistake }) => {
    const [selected, setSelected] = useState(null);
    const [feedback, setFeedback] = useState(null);

    const handleConfirm = () => {
        if (!selected) return;
        const isCorrect = selected === QUIZ_DATA.correctAnswer;
        setFeedback(isCorrect ? 'correct' : 'wrong');
        if (!isCorrect) onMistake();
        setTimeout(() => { if (isCorrect) onComplete(); else { setSelected(null); setFeedback(null); } }, 1500);
    };

    return (
        <div className="p-6 h-full flex flex-col">
            <div className="mb-6">
                <span className="text-xs font-bold text-blue-500 uppercase">Desafio de Conhecimento</span>
                <h2 className="text-xl font-bold text-slate-800 mt-2">{QUIZ_DATA.question}</h2>
            </div>
            <div className="space-y-3 flex-grow">
                {QUIZ_DATA.options.map((opt, idx) => (
                    <button key={idx} onClick={() => !feedback && setSelected(opt)} 
                        className={`w-full p-4 rounded-xl text-left font-bold border-2 transition-all ${feedback === 'correct' && opt === QUIZ_DATA.correctAnswer ? 'bg-green-100 border-green-500 text-green-700' : feedback === 'wrong' && selected === opt ? 'bg-red-100 border-red-500 text-red-700' : selected === opt ? 'bg-blue-50 border-blue-500 text-blue-700' : 'bg-white border-slate-200 text-slate-600'}`}>
                        {opt}
                    </button>
                ))}
            </div>
            {feedback === 'wrong' && <p className="text-center text-red-500 font-bold mb-2 text-sm">{QUIZ_DATA.hint}</p>}
            <button onClick={handleConfirm} className="w-full py-4 bg-blue-600 text-white font-bold rounded-xl">Confirmar</button>
        </div>
    );
};

// JOGO 2: MEMÓRIA (Corrigido)
const MemoryGame = ({ onComplete }) => {
    const [cards, setCards] = useState([]);
    const [flipped, setFlipped] = useState([]);
    const [matched, setMatched] = useState([]);

    useEffect(() => {
        // Duplicar e embaralhar
        const deck = [...MEMORY_CARDS, ...MEMORY_CARDS]
            .sort(() => Math.random() - 0.5)
            .map((card, index) => ({ ...card, uniqueId: index }));
        setCards(deck);
    }, []);

    const handleCardClick = (id) => {
        if (flipped.length === 2 || flipped.includes(id) || matched.includes(cards.find(c => c.uniqueId === id).id)) return;
        
        const newFlipped = [...flipped, id];
        setFlipped(newFlipped);

        if (newFlipped.length === 2) {
            const card1 = cards.find(c => c.uniqueId === newFlipped[0]);
            const card2 = cards.find(c => c.uniqueId === newFlipped[1]);
            
            if (card1.id === card2.id) {
                setMatched([...matched, card1.id]);
                setFlipped([]);
                if (matched.length + 1 === MEMORY_CARDS.length) setTimeout(onComplete, 1000);
            } else {
                setTimeout(() => setFlipped([]), 1000);
            }
        }
    };

    return (
        <div className="p-4 h-full flex flex-col">
            <h2 className="text-center font-black text-slate-700 mb-4">Encontre os Pares da Orla</h2>
            <div className="grid grid-cols-3 gap-3 flex-grow content-center">
                {cards.map((card) => {
                    const isFlipped = flipped.includes(card.uniqueId) || matched.includes(card.id);
                    // CORREÇÃO: Atribuir o ícone a uma variável capitalizada para o React entender como componente
                    const IconComponent = card.icon;
                    
                    return (
                        <button key={card.uniqueId} onClick={() => handleCardClick(card.uniqueId)} 
                            className={`aspect-square rounded-xl flex items-center justify-center transition-all duration-500 transform ${isFlipped ? 'bg-yellow-400 rotate-0' : 'bg-slate-200 rotate-y-180'}`}>
                            {isFlipped ? (
                                <div className="flex flex-col items-center animate-in zoom-in">
                                    <IconComponent size={24} className="text-white mb-1" />
                                    <span className="text-[10px] font-bold text-yellow-900 uppercase">{card.name}</span>
                                </div>
                            ) : <HelpCircle className="text-slate-300" />}
                        </button>
                    )
                })}
            </div>
        </div>
    );
};

// JOGO 3: DRAG AND DROP (Já existente)
const DragDropGame = ({ onComplete }) => {
    const [targets, setTargets] = useState(DRAG_DATA.pairs.map(p => ({ ...p, assigned: null })));
    const [options, setOptions] = useState(DRAG_DATA.sources);
    const [selectedOption, setSelectedOption] = useState(null);

    const handleAssign = (targetId) => {
        if (!selectedOption) return;
        const newTargets = targets.map(t => t.id === targetId ? { ...t, assigned: selectedOption } : t);
        const newOptions = options.filter(o => o.id !== selectedOption.id);
        // Se já tinha um, devolve
        const oldTarget = targets.find(t => t.id === targetId);
        if (oldTarget.assigned) newOptions.push(oldTarget.assigned);

        setTargets(newTargets);
        setOptions(newOptions);
        setSelectedOption(null);

        if (newTargets.every(t => t.assigned && t.assigned.content === t.description)) {
            setTimeout(onComplete, 1000);
        }
    };

    return (
        <div className="p-4 h-full flex flex-col">
            <h2 className="text-center font-bold text-slate-700 mb-4">Conecte o Poder</h2>
            <div className="space-y-3 flex-grow">
                {targets.map(t => (
                    <div key={t.id} onClick={() => handleAssign(t.id)} 
                        className={`p-4 rounded-xl border-2 border-dashed flex justify-between items-center transition-all ${t.assigned ? 'border-blue-500 bg-blue-50' : 'border-slate-300'}`}>
                        <span className="font-bold text-slate-600">{t.target}</span>
                        <div className={`px-3 py-1 rounded text-xs font-bold ${t.assigned ? 'bg-blue-500 text-white' : 'bg-slate-200 text-slate-400'}`}>
                            {t.assigned ? t.assigned.content : '?'}
                        </div>
                    </div>
                ))}
            </div>
            <div className="flex flex-wrap gap-2 justify-center mt-4 pb-4">
                {options.map(opt => (
                    <button key={opt.id} onClick={() => setSelectedOption(opt)} 
                        className={`px-4 py-2 rounded-full font-bold text-sm border-2 ${selectedOption?.id === opt.id ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-200'}`}>
                        {opt.content}
                    </button>
                ))}
            </div>
        </div>
    );
};

// JOGO 4: SPELL TYPER (Novo)
const SpellTyperGame = ({ onComplete }) => {
    const [spellIdx, setSpellIdx] = useState(0);
    const [input, setInput] = useState('');
    const currentSpell = SPELL_DATA[spellIdx];
    const [shake, setShake] = useState(false);

    const handleSubmit = (e) => {
        e.preventDefault();
        if (input.toLowerCase().trim() === currentSpell.spell.toLowerCase().trim()) {
            setInput('');
            if (spellIdx + 1 < SPELL_DATA.length) setSpellIdx(prev => prev + 1);
            else onComplete();
        } else {
            setShake(true);
            setTimeout(() => setShake(false), 500);
        }
    };

    return (
        <div className="p-6 h-full flex flex-col justify-center items-center bg-slate-900 text-white">
            <div className="mb-8 text-center">
                <div className="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/50">
                    <Zap className="w-8 h-8 text-white" />
                </div>
                <p className="text-blue-300 font-bold uppercase tracking-widest text-xs mb-2">Feitiço {spellIdx + 1}/{SPELL_DATA.length}</p>
                <h2 className="text-2xl font-black mb-2">{currentSpell.spell}</h2>
                <p className="text-slate-400 text-sm italic">"{currentSpell.meaning}"</p>
            </div>

            <form onSubmit={handleSubmit} className="w-full">
                <input 
                    autoFocus
                    value={input}
                    onChange={e => setInput(e.target.value)}
                    className={`w-full bg-slate-800 border-2 border-slate-700 rounded-xl p-4 text-center font-bold text-lg focus:border-blue-500 focus:outline-none transition-all ${shake ? 'border-red-500 translate-x-2' : ''}`}
                    placeholder="Digite o feitiço..."
                />
                <button type="submit" className="w-full mt-4 py-4 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold transition shadow-lg shadow-blue-900">
                    Lançar Feitiço
                </button>
            </form>
        </div>
    );
};

// JOGO 5: BATTLE (Novo - Estilo RPG Simples)
const BattleGame = ({ onComplete, onMistake }) => {
    const [enemyHp, setEnemyHp] = useState(BATTLE_DATA.enemyMaxHp);
    const [playerHp, setPlayerHp] = useState(BATTLE_DATA.playerMaxHp);
    const [log, setLog] = useState("Cruhell apareceu! Escolha sua ação.");
    const [turn, setTurn] = useState('player'); // player | enemy

    useEffect(() => {
        if (enemyHp <= 0) setTimeout(onComplete, 1500);
        if (playerHp <= 0) onMistake();
    }, [enemyHp, playerHp]);

    const enemyTurn = () => {
        setTimeout(() => {
            const dmg = Math.floor(Math.random() * 15) + 5;
            setPlayerHp(prev => Math.max(0, prev - dmg));
            setLog(`Cruhell lançou "Poignards de la mort"! -${dmg} HP`);
            setTurn('player');
        }, 1500);
    };

    const handleAction = (type) => {
        if (turn !== 'player') return;

        if (type === 'attack') {
            const dmg = Math.floor(Math.random() * 20) + 10;
            setEnemyHp(prev => Math.max(0, prev - dmg));
            setLog(`Você usou "Gust Incinerante"! -${dmg} HP no inimigo.`);
            setTurn('enemy');
            enemyTurn();
        } else if (type === 'heal') {
            const heal = 25;
            setPlayerHp(prev => Math.min(BATTLE_DATA.playerMaxHp, prev + heal));
            setLog(`Você usou o Pó de Estrela! +${heal} HP.`);
            setTurn('enemy');
            enemyTurn();
        }
    };

    return (
        <div className="h-full flex flex-col bg-slate-50">
            {/* Área do Inimigo */}
            <div className="bg-slate-800 p-6 pb-10 rounded-b-3xl text-white text-center relative shadow-xl">
                <div className="w-20 h-20 bg-red-900 rounded-full mx-auto flex items-center justify-center mb-3 border-4 border-red-700">
                    <Ghost size={40} />
                </div>
                <h3 className="font-black text-xl text-red-100">{BATTLE_DATA.enemyName}</h3>
                <div className="w-full bg-slate-900 h-3 rounded-full mt-2 overflow-hidden border border-slate-700">
                    <div className="bg-red-500 h-full transition-all duration-500" style={{ width: `${(enemyHp / BATTLE_DATA.enemyMaxHp) * 100}%` }}></div>
                </div>
            </div>

            {/* Log de Batalha */}
            <div className="flex-grow p-6 flex items-center justify-center">
                <p className="text-center text-slate-600 font-bold italic animate-pulse">{log}</p>
            </div>

            {/* Controles do Jogador */}
            <div className="p-6 bg-white border-t border-slate-200">
                <div className="flex justify-between items-center mb-4">
                    <span className="font-bold text-slate-700">Peter Richt</span>
                    <span className="font-bold text-green-600">{playerHp}/{BATTLE_DATA.playerMaxHp} HP</span>
                </div>
                <div className="grid grid-cols-2 gap-3">
                    <button onClick={() => handleAction('attack')} disabled={turn !== 'player'} className="bg-red-100 text-red-600 p-4 rounded-xl font-bold flex flex-col items-center border-2 border-red-200 hover:bg-red-200 transition active:scale-95 disabled:opacity-50">
                        <Flame className="mb-1" /> Atacar
                    </button>
                    <button onClick={() => handleAction('heal')} disabled={turn !== 'player'} className="bg-green-100 text-green-600 p-4 rounded-xl font-bold flex flex-col items-center border-2 border-green-200 hover:bg-green-200 transition active:scale-95 disabled:opacity-50">
                        <RefreshCw className="mb-1" /> Curar
                    </button>
                </div>
            </div>
        </div>
    );
};

// JOGO 6: UNSCRAMBLE (Novo - Puzzle)
const UnscrambleGame = ({ onComplete }) => {
    const [pieces, setPieces] = useState([...PUZZLE_DATA.scrambled]);
    const [ordered, setOrdered] = useState([]);

    const handleSelect = (piece) => {
        setPieces(pieces.filter(p => p.id !== piece.id));
        setOrdered([...ordered, piece]);
    };

    const handleReset = () => {
        setPieces([...PUZZLE_DATA.scrambled]);
        setOrdered([]);
    };

    const handleCheck = () => {
        const currentText = ordered.map(p => p.text).join(" ");
        const correctText = PUZZLE_DATA.correctOrder.join(" ");
        
        if (currentText === correctText) onComplete();
        else alert("A ordem está incorreta. Tente novamente!");
    };

    return (
        <div className="p-6 h-full flex flex-col bg-[#fffbeb]">
            <div className="text-center mb-6">
                <FileText className="w-12 h-12 text-amber-600 mx-auto mb-2" />
                <h2 className="text-xl font-black text-amber-800">Restaure a Página Rasgada</h2>
                <p className="text-amber-700 text-sm mt-1">Clique nos trechos para formar a frase final.</p>
            </div>

            {/* Área de Montagem */}
            <div className="bg-white border-2 border-amber-200 p-4 rounded-xl min-h-[150px] mb-6 shadow-inner flex flex-wrap content-start gap-2">
                {ordered.length === 0 && <span className="text-slate-300 w-full text-center self-center italic">O texto aparecerá aqui...</span>}
                {ordered.map((p, idx) => (
                    <span key={idx} className="bg-amber-100 text-amber-900 px-2 py-1 rounded border border-amber-300 font-serif font-medium">
                        {p.text}
                    </span>
                ))}
            </div>

            {/* Peças */}
            <div className="flex flex-wrap gap-2 justify-center flex-grow content-start">
                {pieces.map(p => (
                    <button key={p.id} onClick={() => handleSelect(p)} className="bg-white text-slate-700 px-4 py-3 rounded-lg shadow-sm border border-slate-200 font-medium hover:bg-slate-50 active:scale-95 transition">
                        {p.text}
                    </button>
                ))}
            </div>

            <div className="flex gap-3 mt-auto">
                <button onClick={handleReset} className="p-4 bg-slate-200 text-slate-600 rounded-xl font-bold"><RefreshCw /></button>
                <button onClick={handleCheck} className="flex-grow p-4 bg-amber-500 text-white rounded-xl font-bold shadow-lg shadow-amber-200">Verificar Página</button>
            </div>
        </div>
    );
};

// ====================================================================
// --- APP PRINCIPAL ---
// ====================================================================

const App = () => {
  const [screen, setScreen] = useState('Auth');
  const [currentUser, setCurrentUser] = useState(null);
  const [progress, setProgress] = useState({ currentModuleId: 'm1', completedModules: [] });
  const [currentGame, setCurrentGame] = useState(null);
  const [userHearts, setUserHearts] = useState(5);
  const [showWinModal, setShowWinModal] = useState(false);
  const [users, setUsers] = useState(INITIAL_USERS);

  // Auth Logic
  const handleLogin = (user) => { setCurrentUser(user); setScreen('Home'); };
  const handleRegister = (u) => { setUsers([...users, u]); setCurrentUser(u); setScreen('Home'); };

  // Game Logic
  const startGame = (module) => {
      setCurrentGame(module);
      setScreen('Game');
  };

  const handleWin = () => {
      setShowWinModal(true);
      const currIdx = MAP_STRUCTURE.findIndex(m => m.id === currentGame.id);
      const nextModule = MAP_STRUCTURE[currIdx + 1];
      
      setProgress(prev => ({
          ...prev,
          completedModules: [...prev.completedModules, currentGame.id],
          currentModuleId: nextModule ? nextModule.id : 'completed'
      }));
  };

  const handleCloseWin = () => {
      setShowWinModal(false);
      setScreen('Map');
  };

  // Component Renders
  const renderGame = () => {
      switch(currentGame?.gameType) {
          case 'Quiz': return <QuizGame onComplete={handleWin} onMistake={() => setUserHearts(h => h-1)} />;
          case 'DragAndDrop': return <DragDropGame onComplete={handleWin} />;
          case 'Memory': return <MemoryGame onComplete={handleWin} />;
          case 'SpellTyper': return <SpellTyperGame onComplete={handleWin} />;
          case 'Battle': return <BattleGame onComplete={handleWin} onMistake={() => setUserHearts(h => h-1)} />;
          case 'Unscramble': return <UnscrambleGame onComplete={handleWin} />;
          default: return <div>Jogo não encontrado</div>;
      }
  };

  // --- TELA DE AUTH ---
  if (screen === 'Auth') {
    return (
        <div className="max-w-md mx-auto bg-white h-screen flex flex-col p-6 justify-center">
             <div className="text-center mb-10">
                <div className="w-20 h-20 bg-yellow-100 rounded-3xl mx-auto flex items-center justify-center mb-4 rotate-3">
                    <Feather className="w-10 h-10 text-yellow-600" />
                </div>
                <h1 className="text-3xl font-black text-slate-800">{APP_NAME}</h1>
                <p className="text-slate-500">Aventure-se por Inária</p>
             </div>
             
             <div className="space-y-3">
                <h2 className="text-sm font-bold text-slate-400 uppercase">Usuários Disponíveis (Mock)</h2>
                {users.map(u => (
                    <button key={u.username} onClick={() => handleLogin(u)} className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl flex items-center justify-between hover:bg-slate-100 transition">
                        <span className="font-bold text-slate-700">{u.name}</span>
                        {/* CORREÇÃO: ChevronRight agora está importado */}
                        <ChevronRight className="text-slate-400" size={16} />
                    </button>
                ))}
             </div>

             <button onClick={() => {
                 const name = prompt("Nome:");
                 const user = prompt("Usuário:");
                 if(name && user) handleRegister({ username: user, name, password: '123', email: 'novo@test.com' });
             }} className="mt-6 w-full py-4 border-2 border-slate-200 text-slate-600 font-bold rounded-xl">
                 Criar Novo Usuário
             </button>
        </div>
    );
  }

  // --- TELA PRINCIPAL (HOME) ---
  if (screen === 'Home') {
      return (
          <div className="max-w-md mx-auto bg-slate-50 h-screen flex flex-col">
              <div className="bg-white p-6 shadow-sm flex justify-between items-center">
                  <div>
                      <p className="text-xs font-bold text-slate-400 uppercase">Olá, {currentUser.name}</p>
                      <h2 className="text-xl font-black text-slate-800">Seus Livros</h2>
                  </div>
                  <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold">
                      {currentUser.name[0]}
                  </div>
              </div>

              <div className="p-6 flex-grow">
                  {MOCK_BOOKS.map(book => (
                      <div key={book.id} onClick={() => setScreen('Map')} className="bg-white p-4 rounded-2xl border-2 border-yellow-400 shadow-xl shadow-yellow-100 cursor-pointer transform transition hover:scale-[1.02]">
                          <div className="flex items-center space-x-4">
                              <div className="w-16 h-16 bg-yellow-500 rounded-xl flex items-center justify-center text-white shadow-lg">
                                  <Feather size={32} />
                              </div>
                              <div>
                                  <h3 className="font-bold text-lg text-slate-800">{book.title}</h3>
                                  <div className="flex items-center space-x-2 mt-1">
                                    <span className="text-xs font-bold bg-slate-100 px-2 py-1 rounded text-slate-500">6 Fases</span>
                                    <span className="text-xs font-bold text-yellow-600">
                                        {Math.round((progress.completedModules.length / MAP_STRUCTURE.length) * 100)}% Completo
                                    </span>
                                  </div>
                              </div>
                          </div>
                      </div>
                  ))}

                  <div className="mt-8 p-6 bg-blue-600 rounded-2xl text-white shadow-lg shadow-blue-200">
                      <div className="flex items-center space-x-2 mb-2">
                          <Award className="text-blue-200" />
                          <span className="font-bold uppercase text-xs text-blue-200">Próxima Conquista</span>
                      </div>
                      <h3 className="font-bold text-lg">Guardião de Inária</h3>
                      <p className="text-sm text-blue-100 mt-1 opacity-80">Complete todos os 6 mini-games para ganhar este título.</p>
                  </div>
              </div>
          </div>
      );
  }

  // --- TELA DO MAPA ---
  if (screen === 'Map') {
      return (
        <div className="max-w-md mx-auto bg-slate-100 h-screen flex flex-col">
            <div className="bg-white p-4 sticky top-0 z-10 shadow-sm flex items-center justify-between">
                <button onClick={() => setScreen('Home')}><ArrowLeft className="text-slate-400" /></button>
                <span className="font-bold text-slate-700">Mapa da Jornada</span>
                <Settings className="text-slate-400" />
            </div>

            <div className="flex-grow overflow-y-auto p-6 pb-24 relative">
                {/* Linha do Mapa */}
                <div className="absolute left-1/2 top-10 bottom-10 w-1 bg-slate-300 -translate-x-1/2 rounded-full" />
                
                <div className="space-y-10 relative z-10">
                    {MAP_STRUCTURE.map((mod, idx) => {
                        const isCompleted = progress.completedModules.includes(mod.id);
                        const isCurrent = progress.currentModuleId === mod.id;
                        const isLocked = !isCompleted && !isCurrent;
                        
                        return (
                            <div key={mod.id} className={`flex flex-col items-center ${idx % 2 === 0 ? 'mr-auto pr-12 self-start' : 'ml-auto pl-12 self-end'} w-1/2 relative`}>
                                {/* Conector Horizontal */}
                                <div className={`absolute top-8 h-1 w-12 bg-slate-300 ${idx % 2 === 0 ? 'right-0' : 'left-0'}`} />

                                <button 
                                    disabled={isLocked}
                                    onClick={() => startGame(mod)}
                                    className={`w-16 h-16 rounded-full border-4 shadow-lg flex items-center justify-center transition-transform active:scale-95 z-20
                                    ${isCompleted ? 'bg-yellow-400 border-yellow-500 text-white' : isCurrent ? 'bg-blue-500 border-blue-600 text-white ring-4 ring-blue-200' : 'bg-slate-200 border-slate-300 text-slate-400'}`}>
                                    {isCompleted ? <Check /> : isLocked ? <Lock size={20} /> : <Star fill="currentColor" />}
                                </button>
                                <div className="mt-2 bg-white p-2 rounded-lg shadow-sm text-center min-w-[120px]">
                                    <p className="text-[10px] font-bold text-slate-400 uppercase mb-1">Fase {idx + 1}</p>
                                    <p className="text-xs font-bold text-slate-700 leading-tight">{mod.title}</p>
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>
        </div>
      );
  }

  // --- TELA DE JOGO ---
  if (screen === 'Game') {
      return (
        <div className="max-w-md mx-auto bg-white h-screen flex flex-col">
            <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                <button onClick={() => setScreen('Map')}><X className="text-slate-400" /></button>
                <span className="font-bold text-slate-700">{currentGame.title}</span>
                <HeartsDisplay count={userHearts} />
            </div>
            <div className="flex-grow overflow-hidden relative">
                {renderGame()}
            </div>

            {showWinModal && (
                <Modal title="Fase Concluída!" onClose={handleCloseWin} color="green">
                    <div className="text-center">
                        <div className="bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <Trophy className="w-10 h-10 text-green-600" />
                        </div>
                        <p>Você dominou esta parte da história!</p>
                        <p className="text-sm mt-2 text-slate-400">+150 XP</p>
                    </div>
                </Modal>
            )}
        </div>
      );
  }

  return <div>Carregando...</div>;
};

export default App;
